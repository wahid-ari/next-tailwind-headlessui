import { useContext, useEffect, useState } from 'react';
import Head from 'next/head';
import Image from 'next/image';
import { useRouter } from 'next/router';
import { MoonIcon, PhotographIcon, SunIcon } from '@heroicons/react/outline';
import { GlobalContext } from '@utils/GlobalContext';
import axios from 'axios';

import { supabase } from '@/utils/supabase';

import Button from '@/components/Button';
import FileInput from '@/components/FileInput';
import Spinner from '@/components/Spinner';
import BackToTop from '@components/BackToTop';
import Footer from '@components/Footer';
import Layout from '@components/Layout';
import Navbar from '@components/Navbar';
import Section from '@components/Section';
import TocLink from '@components/TocLink';

export default function FilesSupabase() {
  const router = useRouter();
  const { darkMode, setDarkMode } = useContext(GlobalContext);
  const [isLoading, setIsLoading] = useState(false);

  const [file, setFile] = useState();
  const [fileURL, setFileURL] = useState();
  function handleFileChange(e) {
    if (e.target.files[0]) {
      setFile(e.target.files[0]);
      setFileURL(URL.createObjectURL(e.target.files[0]));
    }
  }

  const [fileRes, setFileRes] = useState();
  async function handleFileUpload(e) {
    e.preventDefault();
    setIsLoading(true);
    const fileToUpload = new FormData();
    fileToUpload.append('name', 'name');
    fileToUpload.append('file', file);
    try {
      const res = await axios.post(`/api/file-supabase`, fileToUpload);
      console.log(res);
      if (res.status == 200) {
        setFileRes(res.data);
        setFile(null);
        setFileURL(null);
        setFetched(false);
      }
    } catch (error) {
      console.error(error.response);
    }
    // new Response(fileToUpload).text().then(console.log)
    // const res = await fetch('/api/file-supabase', {
    //   method: 'POST',
    //   body: fileToUpload
    // });
    // console.log(res);
    // const result = await res.json();
    // if (res.status == 200) {
    //   console.log(result)
    //   setFileRes(result);
    //   setFile(null);
    //   setFileURL(null);
    //   setFetched(false);
    // } else {
    //   console.error(result);
    // }
    setIsLoading(false);
  }

  async function handleDeleteFile(id, name) {
    setIsLoading(true);
    try {
      const res = await axios.delete(`/api/file-supabase?id=${id}&name=${name}`);
      console.log(res);
      if (res.status == 200) {
        setFileRes(null);
        setFile(null);
        setFileURL(null);
        setFetched(false);
      }
    } catch (error) {
      console.error(error);
    } finally {
      setIsLoading(false);
    }
  }

  async function handleDownloadFile(name) {
    const { data } = supabase.storage.from('storage').getPublicUrl(name, {
      download: true,
    });
    router.push(data.publicUrl);
    console.log(data.publicUrl);
  }

  const [bucket, setBucket] = useState(null);
  async function fetchBucket() {
    const { data, error } = await supabase.storage.getBucket('storage');
    // console.log(data);
    setBucket(data);
  }

  const [listFile, setListFile] = useState(null);
  async function fetchData() {
    const { data, error } = await supabase.storage.from('storage').list();
    setListFile(data);
    // console.log(data);
  }

  const [listFileInsideFolder, setListFileInsideFolder] = useState(null);
  async function fetchDataInsideFolder() {
    const { data, error } = await supabase.storage.from('storage').list('folder');
    setListFileInsideFolder(data);
    // console.log(data);
  }

  const [media, setMedia] = useState(null);
  async function fetchMedia() {
    const { data, error } = await supabase.from('storage').select('*');
    setMedia(data);
    // console.log(data);
  }

  const [fetched, setFetched] = useState(false);
  useEffect(() => {
    if (!fetched) {
      fetchBucket();
      fetchData();
      fetchDataInsideFolder();
      fetchMedia();
    }
    setFetched(true);
  }, [fetched]);

  return (
    <div>
      <Head>
        <title>File Supabase Page</title>
        <meta name='description' content='Generated by create next app' />
        <link rel='icon' href='/favicon.ico' />
      </Head>

      <Navbar />

      <Layout>
        <main className='mx-auto max-w-7xl px-4 pb-16 sm:px-6 md:px-8'>
          <Section id='components' name='File TOC'>
            <div className='grid sm:grid-cols-2 md:grid-cols-3'>
              <div>
                <TocLink href='#input-file' text='Input File' />
              </div>
            </div>
          </Section>

          <p>all bucket</p>
          <pre className='text-sm'>{JSON.stringify(bucket, null, 2)}</pre>
          <p className='mt-4'>all file and folder inside bucket</p>
          <pre className='text-sm'>{JSON.stringify(listFile, null, 2)}</pre>
          <p className='mt-4'>
            all file and folder inside {'"'}
            <b>folder</b>
            {'"'}
          </p>
          <pre className='text-sm'>{JSON.stringify(listFileInsideFolder, null, 2)}</pre>
          <p className='mt-4'>
            all Media Record from <b>Storage</b> table
          </p>
          <div className='overflow-auto'>
            <pre className='text-sm'>{JSON.stringify(media, null, 2)}</pre>
          </div>
          <div className='overflow-auto'>
            <table className='border-collapse border dark:border-neutral-600'>
              <thead>
                <tr className='border-y dark:border-neutral-600'>
                  <td className='border-x px-3 py-2 dark:border-neutral-600'>No</td>
                  <td className='border-x px-3 py-2 dark:border-neutral-600'>Name</td>
                  <td className='border-x px-3 py-2 dark:border-neutral-600'>Preview</td>
                  <td className='border-x px-3 py-2 dark:border-neutral-600'>Type</td>
                  <td className='border-x px-3 py-2 dark:border-neutral-600'>Path</td>
                  <td className='border-x px-3 py-2 dark:border-neutral-600'>Full Path</td>
                  <td className='border-x px-3 py-2 dark:border-neutral-600'>Size</td>
                  <td className='border-x px-3 py-2 dark:border-neutral-600'>Action</td>
                </tr>
              </thead>
              <tbody>
                {media?.map((item, index) => (
                  <tr key={item.name} className='border-y dark:border-neutral-600'>
                    <td className='border-x px-3 py-2 dark:border-neutral-600'>{index + 1}</td>
                    <td className='border-x px-3 py-2 dark:border-neutral-600'>{item.name}</td>
                    <td className='border-x px-3 py-2 dark:border-neutral-600'>
                      {item.type.startsWith('image') ? (
                        <div className='relative h-8 w-8'>
                          <Image alt='file' src={item.url} fill className='object-cover object-center' />
                        </div>
                      ) : item.type == 'application/pdf' ? (
                        <>
                          <embed src={item.url} width='100' height='100' />
                        </>
                      ) : null}
                    </td>
                    <td className='border-x px-3 py-2 dark:border-neutral-600'>{item.type}</td>
                    <td className='border-x px-3 py-2 dark:border-neutral-600'>{item.path}</td>
                    <td className='border-x px-3 py-2 dark:border-neutral-600'>{item.fullpath}</td>
                    <td className='border-x px-3 py-2 dark:border-neutral-600'>{(item.size / 1024).toFixed(2)} KB</td>
                    <td className='border-x px-3 py-2 dark:border-neutral-600'>
                      <div className='flex items-center gap-1'>
                        <Button.green className='flex items-center' onClick={() => handleDownloadFile(item.name)}>
                          Download
                        </Button.green>
                        <Button.red className='flex items-center' onClick={() => handleDeleteFile(item.id, item.name)}>
                          {isLoading && <Spinner.red small className='!h-4 !w-4' />}Delete
                        </Button.red>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <Section id='input-file' name='Input File'>
            <p>
              this upload file to <b>Supabase storage</b> via <b>/api/file-supabase</b>
            </p>
            <FileInput
              label='File'
              accept='.pdf'
              name='file'
              inputLabel='Select file (.pdf)'
              value={file ? file.name : ''}
              onChange={handleFileChange}
              icon={<PhotographIcon className='mr-1 h-6 w-6 text-gray-400' strokeWidth='1' />}
            />
            {fileURL && (
              <>
                <embed src={fileURL} width='500' height='500' />
                <Button className='flex items-center' onClick={handleFileUpload}>
                  {isLoading && <Spinner small className='!h-4 !w-4' />}
                  Upload
                </Button>
              </>
            )}
            {fileRes && (
              <>
                <div className='overflow-auto'>
                  <pre className='mt-2 rounded-md bg-neutral-100 p-2 dark:bg-neutral-950'>
                    <code className='text-sm text-neutral-800 dark:text-white'>{JSON.stringify(fileRes, null, 2)}</code>
                  </pre>
                </div>
                <embed src={fileRes?.data?.url} width='500' height='500' />
              </>
            )}
          </Section>

          <div className='fixed bottom-20 right-3 z-10 mx-4 rounded bg-gray-100 bg-opacity-20 !py-2 px-2 backdrop-blur backdrop-filter dark:bg-neutral-800 dark:bg-opacity-40 md:right-10'>
            {darkMode ? (
              <button
                onClick={() => setDarkMode(!darkMode)}
                aria-label='Change Theme'
                className='h-8 w-8 rounded-full bg-neutral-800 p-1 text-white transition-all duration-300 ease-in hover:bg-neutral-700'
              >
                <SunIcon />
              </button>
            ) : (
              <button
                onClick={() => setDarkMode(!darkMode)}
                aria-label='Change Theme'
                className='h-8 w-8 rounded-full bg-gray-100 p-1 transition-all duration-300 ease-in hover:bg-gray-200'
              >
                <MoonIcon />
              </button>
            )}
          </div>

          <BackToTop />
        </main>

        <Footer />
      </Layout>
    </div>
  );
}
